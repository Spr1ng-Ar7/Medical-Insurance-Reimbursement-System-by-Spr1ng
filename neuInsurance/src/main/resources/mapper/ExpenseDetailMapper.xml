<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.neu.insurance.mapper.ExpenseDetailMapper">

    <!-- 结果映射 -->
    <resultMap id="BaseResultMap" type="org.neu.insurance.entity.ExpenseDetail">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="patient_id" property="patientId" jdbcType="BIGINT"/>
        <result column="order_id" property="orderId" jdbcType="BIGINT"/>
        <result column="item_type" property="itemType" jdbcType="VARCHAR"/>
        <result column="item_id" property="itemId" jdbcType="BIGINT"/>
        <result column="item_code" property="itemCode" jdbcType="VARCHAR"/>
        <result column="item_name" property="itemName" jdbcType="VARCHAR"/>
        <result column="specification" property="specification" jdbcType="VARCHAR"/>
        <result column="unit" property="unit" jdbcType="VARCHAR"/>
        <result column="quantity" property="quantity" jdbcType="INTEGER"/>
        <result column="unit_price" property="unitPrice" jdbcType="DECIMAL"/>
        <result column="total_amount" property="totalAmount" jdbcType="DECIMAL"/>
        <result column="reimbursement_ratio" property="reimbursementRatio" jdbcType="DECIMAL"/>
        <result column="reimbursement_amount" property="reimbursementAmount" jdbcType="DECIMAL"/>
        <result column="self_pay_amount" property="selfPayAmount" jdbcType="DECIMAL"/>
        <result column="service_type" property="serviceType" jdbcType="VARCHAR"/>
        <result column="department" property="department" jdbcType="VARCHAR"/>
        <result column="doctor" property="doctor" jdbcType="VARCHAR"/>
        <result column="expense_date" property="expenseDate" jdbcType="TIMESTAMP"/>
        <result column="status" property="status" jdbcType="INTEGER"/>
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="update_time" property="updateTime" jdbcType="TIMESTAMP"/>
        <result column="create_by" property="createBy" jdbcType="VARCHAR"/>
        <result column="update_by" property="updateBy" jdbcType="VARCHAR"/>
        <result column="remark" property="remark" jdbcType="VARCHAR"/>
    </resultMap>

    <!-- 基础字段 -->
    <sql id="Base_Column_List">
        id, patient_id, order_id, item_type, item_id, item_code, item_name, specification,
        unit, quantity, unit_price, total_amount, reimbursement_ratio, reimbursement_amount,
        self_pay_amount, service_type, department, doctor, expense_date, status,
        create_time, update_time, create_by, update_by, remark
    </sql>

    <!-- 根据条件分页查询费用明细列表 -->
    <select id="selectByCondition" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM expense_detail
        <where>
            <if test="patientId != null">
                AND patient_id = #{patientId}
            </if>
            <if test="orderId != null">
                AND order_id = #{orderId}
            </if>
            <if test="itemType != null and itemType != ''">
                AND item_type = #{itemType}
            </if>
            <if test="itemName != null and itemName != ''">
                AND item_name LIKE CONCAT('%', #{itemName}, '%')
            </if>
            <if test="serviceType != null and serviceType != ''">
                AND service_type = #{serviceType}
            </if>
            <if test="department != null and department != ''">
                AND department = #{department}
            </if>
            <if test="status != null">
                AND status = #{status}
            </if>
            <if test="startDate != null">
                AND expense_date >= #{startDate}
            </if>
            <if test="endDate != null">
                AND expense_date &lt;= #{endDate}
            </if>
        </where>
        ORDER BY expense_date DESC
        LIMIT #{offset}, #{pageSize}
    </select>

    <!-- 根据条件统计费用明细总数 -->
    <select id="countByCondition" resultType="int">
        SELECT COUNT(*)
        FROM expense_detail
        <where>
            <if test="patientId != null">
                AND patient_id = #{patientId}
            </if>
            <if test="orderId != null">
                AND order_id = #{orderId}
            </if>
            <if test="itemType != null and itemType != ''">
                AND item_type = #{itemType}
            </if>
            <if test="itemName != null and itemName != ''">
                AND item_name LIKE CONCAT('%', #{itemName}, '%')
            </if>
            <if test="serviceType != null and serviceType != ''">
                AND service_type = #{serviceType}
            </if>
            <if test="department != null and department != ''">
                AND department = #{department}
            </if>
            <if test="status != null">
                AND status = #{status}
            </if>
            <if test="startDate != null">
                AND expense_date >= #{startDate}
            </if>
            <if test="endDate != null">
                AND expense_date &lt;= #{endDate}
            </if>
        </where>
    </select>

    <!-- 根据ID查询费用明细 -->
    <select id="selectById" parameterType="long" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM expense_detail
        WHERE id = #{id}
    </select>

    <!-- 根据患者ID查询费用明细列表 -->
    <select id="selectByPatientId" parameterType="long" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM expense_detail
        WHERE patient_id = #{patientId}
        ORDER BY expense_date DESC
    </select>

    <!-- 根据订单ID查询费用明细列表 -->
    <select id="selectByOrderId" parameterType="long" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM expense_detail
        WHERE order_id = #{orderId}
        ORDER BY expense_date DESC
    </select>

    <!-- 新增费用明细 -->
    <insert id="insert" parameterType="org.neu.insurance.entity.ExpenseDetail" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO expense_detail (
            patient_id, order_id, item_type, item_id, item_code, item_name, specification,
            unit, quantity, unit_price, total_amount, reimbursement_ratio, reimbursement_amount,
            self_pay_amount, service_type, department, doctor, expense_date, status,
            create_time, update_time, create_by, update_by, remark
        ) VALUES (
            #{patientId}, #{orderId}, #{itemType}, #{itemId}, #{itemCode}, #{itemName}, #{specification},
            #{unit}, #{quantity}, #{unitPrice}, #{totalAmount}, #{reimbursementRatio}, #{reimbursementAmount},
            #{selfPayAmount}, #{serviceType}, #{department}, #{doctor}, #{expenseDate}, #{status},
            #{createTime}, #{updateTime}, #{createBy}, #{updateBy}, #{remark}
        )
    </insert>

    <!-- 更新费用明细 -->
    <update id="update" parameterType="org.neu.insurance.entity.ExpenseDetail">
        UPDATE expense_detail
        <set>
            <if test="patientId != null">patient_id = #{patientId},</if>
            <if test="orderId != null">order_id = #{orderId},</if>
            <if test="itemType != null">item_type = #{itemType},</if>
            <if test="itemId != null">item_id = #{itemId},</if>
            <if test="itemCode != null">item_code = #{itemCode},</if>
            <if test="itemName != null">item_name = #{itemName},</if>
            <if test="specification != null">specification = #{specification},</if>
            <if test="unit != null">unit = #{unit},</if>
            <if test="quantity != null">quantity = #{quantity},</if>
            <if test="unitPrice != null">unit_price = #{unitPrice},</if>
            <if test="totalAmount != null">total_amount = #{totalAmount},</if>
            <if test="reimbursementRatio != null">reimbursement_ratio = #{reimbursementRatio},</if>
            <if test="reimbursementAmount != null">reimbursement_amount = #{reimbursementAmount},</if>
            <if test="selfPayAmount != null">self_pay_amount = #{selfPayAmount},</if>
            <if test="serviceType != null">service_type = #{serviceType},</if>
            <if test="department != null">department = #{department},</if>
            <if test="doctor != null">doctor = #{doctor},</if>
            <if test="expenseDate != null">expense_date = #{expenseDate},</if>
            <if test="status != null">status = #{status},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
            <if test="updateBy != null">update_by = #{updateBy},</if>
            <if test="remark != null">remark = #{remark},</if>
        </set>
        WHERE id = #{id}
    </update>

    <!-- 根据ID删除费用明细 -->
    <delete id="deleteById" parameterType="long">
        DELETE FROM expense_detail WHERE id = #{id}
    </delete>

    <!-- 批量删除费用明细 -->
    <delete id="batchDelete" parameterType="list">
        DELETE FROM expense_detail WHERE id IN
        <foreach collection="list" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <!-- 根据项目类型查询费用明细列表 -->
    <select id="selectByItemType" parameterType="string" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM expense_detail
        WHERE item_type = #{itemType}
        ORDER BY expense_date DESC
    </select>

    <!-- 根据服务类型查询费用明细列表 -->
    <select id="selectByServiceType" parameterType="string" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM expense_detail
        WHERE service_type = #{serviceType}
        ORDER BY expense_date DESC
    </select>

    <!-- 根据科室查询费用明细列表 -->
    <select id="selectByDepartment" parameterType="string" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM expense_detail
        WHERE department = #{department}
        ORDER BY expense_date DESC
    </select>

    <!-- 根据状态查询费用明细列表 -->
    <select id="selectByStatus" parameterType="int" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM expense_detail
        WHERE status = #{status}
        ORDER BY expense_date DESC
    </select>

    <!-- 统计患者总费用 -->
    <select id="sumTotalAmountByPatientId" parameterType="long" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM(total_amount), 0)
        FROM expense_detail
        WHERE patient_id = #{patientId} AND status = 1
    </select>

    <!-- 统计患者报销金额 -->
    <select id="sumReimbursementAmountByPatientId" parameterType="long" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM(reimbursement_amount), 0)
        FROM expense_detail
        WHERE patient_id = #{patientId} AND status = 1
    </select>

    <!-- 统计患者自付金额 -->
    <select id="sumSelfPayAmountByPatientId" parameterType="long" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM(self_pay_amount), 0)
        FROM expense_detail
        WHERE patient_id = #{patientId} AND status = 1
    </select>

    <!-- 获取所有项目类型 -->
    <select id="selectAllItemTypes" resultType="string">
        SELECT DISTINCT item_type 
        FROM expense_detail 
        WHERE item_type IS NOT NULL AND item_type != ''
        ORDER BY item_type
    </select>

    <!-- 获取所有服务类型 -->
    <select id="selectAllServiceTypes" resultType="string">
        SELECT DISTINCT service_type 
        FROM expense_detail 
        WHERE service_type IS NOT NULL AND service_type != ''
        ORDER BY service_type
    </select>

    <!-- 获取所有科室 -->
    <select id="selectAllDepartments" resultType="string">
        SELECT DISTINCT department 
        FROM expense_detail 
        WHERE department IS NOT NULL AND department != ''
        ORDER BY department
    </select>

</mapper> 