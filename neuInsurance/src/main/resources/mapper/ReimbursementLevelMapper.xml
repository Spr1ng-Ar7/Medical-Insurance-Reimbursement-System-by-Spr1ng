<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.neu.insurance.mapper.ReimbursementLevelMapper">

    <!-- 报销等级结果映射 -->
    <resultMap id="ReimbursementLevelResultMap" type="org.neu.insurance.entity.ReimbursementLevel">
        <id property="id" column="id"/>
        <result property="levelCode" column="level_code"/>
        <result property="levelName" column="level_name"/>
        <result property="insuranceType" column="insurance_type"/>
        <result property="hospitalLevel" column="hospital_level"/>
        <result property="minAmount" column="min_amount"/>
        <result property="maxAmount" column="max_amount"/>
        <result property="deductible" column="deductible"/>
        <result property="maxReimbursement" column="max_reimbursement"/>
        <result property="categoryARate" column="category_a_rate"/>
        <result property="categoryBRate" column="category_b_rate"/>
        <result property="categoryCRate" column="category_c_rate"/>
        <result property="treatmentRate" column="treatment_rate"/>
        <result property="serviceRate" column="service_rate"/>
        <result property="status" column="status"/>
        <result property="effectiveTime" column="effective_time"/>
        <result property="expireTime" column="expire_time"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="createBy" column="create_by"/>
        <result property="updateBy" column="update_by"/>
        <result property="remark" column="remark"/>
    </resultMap>

    <!-- 基础字段 -->
    <sql id="Base_Column_List">
        id, level_code, level_name, insurance_type, hospital_level, 
        min_amount, max_amount, deductible, max_reimbursement,
        category_a_rate, category_b_rate, category_c_rate, 
        treatment_rate, service_rate, status, effective_time, 
        expire_time, create_time, update_time, create_by, 
        update_by, remark
    </sql>

    <!-- 分页查询报销等级列表 -->
    <select id="selectReimbursementLevelList" resultMap="ReimbursementLevelResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM reimbursement_level
        <where>
            <if test="levelName != null and levelName != ''">
                AND level_name LIKE CONCAT('%', #{levelName}, '%')
            </if>
            <if test="insuranceType != null and insuranceType != ''">
                AND insurance_type = #{insuranceType}
            </if>
            <if test="hospitalLevel != null and hospitalLevel != ''">
                AND hospital_level = #{hospitalLevel}
            </if>
            <if test="status != null">
                AND status = #{status}
            </if>
        </where>
        ORDER BY create_time DESC
    </select>

    <!-- 根据ID查询报销等级 -->
    <select id="selectReimbursementLevelById" resultMap="ReimbursementLevelResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM reimbursement_level
        WHERE id = #{id}
    </select>

    <!-- 获取有效的报销等级列表 -->
    <select id="selectEffectiveReimbursementLevels" resultMap="ReimbursementLevelResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM reimbursement_level
        WHERE status = 1 
          AND (effective_time IS NULL OR effective_time &lt;= NOW())
          AND (expire_time IS NULL OR expire_time &gt;= NOW())
        ORDER BY level_code
    </select>

    <!-- 根据条件匹配报销等级 -->
    <select id="selectMatchingReimbursementLevels" resultMap="ReimbursementLevelResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM reimbursement_level
        WHERE status = 1 
          AND insurance_type = #{insuranceType}
          AND hospital_level = #{hospitalLevel}
          AND (effective_time IS NULL OR effective_time &lt;= NOW())
          AND (expire_time IS NULL OR expire_time &gt;= NOW())
        ORDER BY level_code
    </select>

    <!-- 新增报销等级 -->
    <insert id="insertReimbursementLevel" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO reimbursement_level (
            level_code, level_name, insurance_type, hospital_level,
            min_amount, max_amount, deductible, max_reimbursement,
            category_a_rate, category_b_rate, category_c_rate,
            treatment_rate, service_rate, status, effective_time,
            expire_time, create_time, update_time, create_by,
            update_by, remark
        ) VALUES (
            #{levelCode}, #{levelName}, #{insuranceType}, #{hospitalLevel},
            #{minAmount}, #{maxAmount}, #{deductible}, #{maxReimbursement},
            #{categoryARate}, #{categoryBRate}, #{categoryCRate},
            #{treatmentRate}, #{serviceRate}, #{status}, #{effectiveTime},
            #{expireTime}, #{createTime}, #{updateTime}, #{createBy},
            #{updateBy}, #{remark}
        )
    </insert>

    <!-- 更新报销等级 -->
    <update id="updateReimbursementLevel">
        UPDATE reimbursement_level
        <set>
            <if test="levelName != null and levelName != ''">level_name = #{levelName},</if>
            <if test="insuranceType != null and insuranceType != ''">insurance_type = #{insuranceType},</if>
            <if test="hospitalLevel != null and hospitalLevel != ''">hospital_level = #{hospitalLevel},</if>
            <if test="minAmount != null">min_amount = #{minAmount},</if>
            <if test="maxAmount != null">max_amount = #{maxAmount},</if>
            <if test="deductible != null">deductible = #{deductible},</if>
            <if test="maxReimbursement != null">max_reimbursement = #{maxReimbursement},</if>
            <if test="categoryARate != null">category_a_rate = #{categoryARate},</if>
            <if test="categoryBRate != null">category_b_rate = #{categoryBRate},</if>
            <if test="categoryCRate != null">category_c_rate = #{categoryCRate},</if>
            <if test="treatmentRate != null">treatment_rate = #{treatmentRate},</if>
            <if test="serviceRate != null">service_rate = #{serviceRate},</if>
            <if test="status != null">status = #{status},</if>
            <if test="effectiveTime != null">effective_time = #{effectiveTime},</if>
            <if test="expireTime != null">expire_time = #{expireTime},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
            <if test="updateBy != null and updateBy != ''">update_by = #{updateBy},</if>
            <if test="remark != null">remark = #{remark},</if>
        </set>
        WHERE id = #{id}
    </update>

    <!-- 删除报销等级 -->
    <delete id="deleteReimbursementLevel">
        DELETE FROM reimbursement_level WHERE id = #{id}
    </delete>

    <!-- 批量删除报销等级 -->
    <delete id="batchDeleteReimbursementLevel">
        DELETE FROM reimbursement_level WHERE id IN
        <foreach collection="ids" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </delete>

    <!-- 检查等级编码是否唯一 -->
    <select id="checkLevelCodeUnique" resultType="int">
        SELECT COUNT(1) FROM reimbursement_level 
        WHERE level_code = #{levelCode}
        <if test="excludeId != null">
            AND id != #{excludeId}
        </if>
    </select>

    <!-- 根据等级编码查询报销等级 -->
    <select id="selectByLevelCode" resultMap="ReimbursementLevelResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM reimbursement_level
        WHERE level_code = #{levelCode}
    </select>

    <!-- 更新状态 -->
    <update id="updateStatus">
        UPDATE reimbursement_level
        SET status = #{status}, update_time = NOW()
        WHERE id = #{id}
    </update>

    <!-- 获取所有报销等级（不分页） -->
    <select id="selectAllReimbursementLevels" resultMap="ReimbursementLevelResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM reimbursement_level
        ORDER BY create_time DESC
    </select>

</mapper> 