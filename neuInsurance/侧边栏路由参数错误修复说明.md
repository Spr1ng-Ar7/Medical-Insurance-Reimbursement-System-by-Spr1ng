# 侧边栏路由参数错误修复说明

## 问题描述
前端项目启动时出现侧边栏相关的路由参数错误：
```
[Vue warn]: Unhandled error during execution of setup function 
Uncaught (in promise) Error: Missing required param "id"
```

错误发生在侧边栏组件 `SidebarItem.vue` 中，当尝试渲染带参数的路由（如 `/drug/edit/:id`）时，由于缺少必需的 `id` 参数导致路由解析失败。

## 错误原因分析

### 1. 路由配置问题
在路由配置中，带参数的路由（如编辑、详情页面）应该在侧边栏中隐藏，但过滤逻辑不完整：

```typescript
// 问题路由示例
{
  path: "/drug/edit/:id",
  name: "DrugEdit",
  component: () => import("@/views/drug/edit.vue"),
  meta: {
    title: "编辑药品",
    showParent: true,
    hidden: true  // 应该隐藏但未被正确过滤
  }
}
```

### 2. 过滤函数缺陷
`router/utils.ts` 中的 `filterTree` 函数只过滤了 `showLink: false` 的路由，但没有过滤 `hidden: true` 的路由：

```typescript
// 修复前的过滤逻辑
function filterTree(data: RouteComponent[]) {
  const newTree = cloneDeep(data).filter(
    (v: { meta: { showLink: boolean } }) => v.meta?.showLink !== false
  );
  // ...
}
```

### 3. 侧边栏渲染问题
侧边栏组件尝试为所有路由创建 `RouterLink`，包括那些带参数的路由，导致参数缺失错误。

## 修复方案

### 1. 修改路由过滤逻辑
更新 `filterTree` 函数，同时过滤 `showLink: false` 和 `hidden: true` 的路由：

```typescript
/** 过滤meta中showLink为false和hidden为true的菜单 */
function filterTree(data: RouteComponent[]) {
  const newTree = cloneDeep(data).filter(
    (v: { meta: { showLink: boolean; hidden: boolean } }) => 
      v.meta?.showLink !== false && v.meta?.hidden !== true
  );
  newTree.forEach(
    (v: { children }) => v.children && (v.children = filterTree(v.children))
  );
  return newTree;
}
```

### 2. 确保路由配置正确
确保所有带参数的路由都正确设置了 `hidden: true`：

```typescript
// 正确的路由配置
{
  path: "/drug/edit/:id",
  name: "DrugEdit",
  component: () => import("@/views/drug/edit.vue"),
  meta: {
    title: "编辑药品",
    showParent: true,
    hidden: true  // 确保设置为隐藏
  }
},
{
  path: "/drug/detail/:id", 
  name: "DrugDetail",
  component: () => import("@/views/drug/detail.vue"),
  meta: {
    title: "药品详情",
    showParent: true,
    hidden: true  // 确保设置为隐藏
  }
}
```

## 修复的路由模块

### 1. 药品管理模块 (`/router/modules/drug.ts`)
- ✅ `/drug/edit/:id` - 编辑药品页面
- ✅ `/drug/detail/:id` - 药品详情页面

### 2. 患者管理模块 (`/router/modules/patient.ts`)
- ✅ `/patient/edit/:id` - 编辑患者页面
- ✅ `/patient/detail/:id` - 患者详情页面

### 3. 医疗订单模块 (`/router/modules/medical-order.ts`)
- ✅ `/medical-order/edit/:id` - 编辑订单页面
- ✅ `/medical-order/detail/:id` - 订单详情页面

### 4. 结算管理模块 (`/router/modules/settlement.ts`)
- ✅ `/settlement/detail/:id` - 结算详情页面

## 技术实现细节

### 1. 过滤逻辑优化
- 同时检查 `showLink` 和 `hidden` 字段
- 递归过滤子路由
- 保持原有的权限过滤逻辑

### 2. 类型安全
- 更新 TypeScript 类型定义
- 确保过滤函数的类型安全
- 避免运行时类型错误

### 3. 向后兼容
- 保持对现有 `showLink` 字段的支持
- 不影响其他路由配置
- 确保菜单显示逻辑正确

## 验证方法

### 1. 启动项目
```bash
cd neuinsurance/neuinsurance
pnpm dev
```

### 2. 检查侧边栏
- 确认侧边栏正常显示
- 确认不再出现路由参数错误
- 确认带参数的路由不在侧边栏中显示

### 3. 功能测试
- 测试从列表页面跳转到编辑/详情页面
- 确认页面正常加载
- 确认路由参数正确传递

## 相关文件修改

### 1. 核心修改
- ✅ `src/router/utils.ts` - 更新路由过滤逻辑

### 2. 路由配置检查
- ✅ `src/router/modules/drug.ts` - 确认隐藏配置
- ✅ `src/router/modules/patient.ts` - 确认隐藏配置
- ✅ `src/router/modules/medical-order.ts` - 确认隐藏配置
- ✅ `src/router/modules/settlement.ts` - 确认隐藏配置

## 预防措施

### 1. 代码规范
- 所有带参数的路由必须设置 `hidden: true`
- 编辑和详情页面不应在侧边栏显示
- 统一路由配置格式

### 2. 类型检查
- 使用 TypeScript 严格模式
- 定义完整的路由元数据类型
- 避免使用 `any` 类型

### 3. 测试策略
- 每次添加新路由时测试侧边栏
- 确保路由参数正确配置
- 定期检查路由过滤逻辑

## 总结

通过修复路由过滤逻辑，成功解决了侧边栏中带参数路由的错误问题：

1. **问题定位准确**：找到了 `filterTree` 函数的过滤逻辑缺陷
2. **修复方案简洁**：只需修改一个过滤函数
3. **影响范围可控**：不影响现有功能，只是增强过滤能力
4. **向后兼容**：保持对现有配置的支持

现在前端项目应该可以正常启动，侧边栏不再出现路由参数错误。 